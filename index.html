<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>4H 爆拉 >8% Logistic 模型</title>
<style>
body{background:#111;color:#fff;font-family:Arial;padding:25px}
button{padding:12px 20px;font-size:16px}
.card{background:#222;padding:15px;margin-top:20px;border-radius:8px}
pre{background:#000;padding:10px;height:260px;overflow:auto}
</style>
</head>
<body>

<h1>USDT 永續 4H >8% 爆拉機率模型</h1>
<button onclick="runAll()">執行（約4~6分鐘）</button>

<div class="card">
<h2>Top5 爆拉機率</h2>
<ul id="top5"></ul>
</div>

<div class="card">
<h2>日誌</h2>
<pre id="logs"></pre>
</div>

<script>

const BINANCE="https://fapi.binance.com";
const BATCH=5;
const SLEEP=500;

function log(t){document.getElementById("logs").innerText+=t+"\n"}
function sleep(ms){return new Promise(r=>setTimeout(r,ms))}

// ====== 技術指標 ======
function EMA(data,p){
  const k=2/(p+1);
  let ema=data[0];
  for(let i=1;i<data.length;i++)
    ema=data[i]*k+ema*(1-k);
  return ema;
}

function RSI(closes,p=48){
  let g=0,l=0;
  for(let i=closes.length-p;i<closes.length;i++){
    let d=closes[i]-closes[i-1];
    if(d>0)g+=d;else l-=d;
  }
  let rs=g/(l||1);
  return 100-(100/(1+rs));
}

function sigmoid(z){return 1/(1+Math.exp(-z));}

// ===== Logistic 迭代 =====
function trainLogistic(X,Y,lr=0.0001,epochs=80){
  const m=X[0].length;
  let beta=new Array(m).fill(0);

  for(let e=0;e<epochs;e++){
    let grads=new Array(m).fill(0);

    for(let i=0;i<X.length;i++){
      let z=0;
      for(let j=0;j<m;j++) z+=beta[j]*X[i][j];
      let p=sigmoid(z);
      let error=p-Y[i];
      for(let j=0;j<m;j++)
        grads[j]+=error*X[i][j];
    }

    for(let j=0;j<m;j++)
      beta[j]-=lr*grads[j]/X.length;
  }
  return beta;
}

async function fetchK(symbol,startTime){
  const url = startTime ?
    `${BINANCE}/fapi/v1/klines?symbol=${symbol}&interval=5m&limit=1500&startTime=${startTime}` :
    `${BINANCE}/fapi/v1/klines?symbol=${symbol}&interval=5m&limit=1500`;

  const r=await fetch(url);
  return await r.json();
}

async function fetch30Days(symbol){
  const now=Date.now();
  const days30 = 30*24*60*60*1000;
  let start=now-days30;
  let all=[];

  while(true){
    const data=await fetchK(symbol,start);
    if(!Array.isArray(data)||data.length==0) break;
    all=all.concat(data);
    start=data[data.length-1][0]+1;
    if(data.length<1500) break;
    await sleep(300);
  }
  return all;
}

// ===== 主流程 =====
async function runAll(){

  document.getElementById("logs").innerText="";
  document.getElementById("top5").innerHTML="";
  log("開始...");

  const ex=await fetch(BINANCE+"/fapi/v1/exchangeInfo");
  const exData=await ex.json();
  const symbols=exData.symbols
    .filter(s=>s.contractType==="PERPETUAL"&&s.quoteAsset==="USDT")
    .map(s=>s.symbol);

  // ===== 第一階段 取前50 =====
  let quickScores=[];
  for(let i=0;i<symbols.length;i+=BATCH){
    const part=symbols.slice(i,i+BATCH);

    await Promise.all(part.map(async sym=>{
      try{
        const raw=await fetchK(sym);
        if(raw.length<200) return;
        const closes=raw.slice(0,-1).map(x=>+x[4]);
        const ema24=EMA(closes.slice(-120),24);
        const ema96=EMA(closes.slice(-120),96);
        const spread=(ema24-ema96)/ema96;
        quickScores.push({symbol:sym,score:spread});
      }catch(e){}
    }));

    await sleep(SLEEP);
  }

  quickScores.sort((a,b)=>b.score-a.score);
  const top50=quickScores.slice(0,50);
  log("Top50 選出完成");

  // ===== 第二階段 Logistic =====
  let results=[];

  for(let i=0;i<top50.length;i+=BATCH){
    const part=top50.slice(i,i+BATCH);

    await Promise.all(part.map(async item=>{
      try{
        const raw=await fetch30Days(item.symbol);
        if(raw.length<3000) return;

        const k=raw.slice(0,-1);
        const closes=k.map(x=>+x[4]);
        const vols=k.map(x=>+x[5]);

        let X=[],Y=[];
        for(let t=200;t<closes.length-48;t++){

          const window=closes.slice(0,t+1);
          const rsi=RSI(window,48);
          const ema24=EMA(window.slice(-120),24);
          const ema96=EMA(window.slice(-120),96);
          const spread=(ema24-ema96)/ema96;
          const macd=EMA(window.slice(-120),24)-EMA(window.slice(-120),96);
          const volRatio=vols[t]/(vols.slice(t-48,t).reduce((a,b)=>a+b)/48);

          const future=(closes[t+48]-closes[t])/closes[t];

          X.push([1,rsi/100,spread,macd,volRatio]);
          Y.push(future>0.08?1:0);
        }

        const beta=trainLogistic(X,Y);

        const latestRSI=RSI(closes,48)/100;
        const ema24=EMA(closes.slice(-120),24);
        const ema96=EMA(closes.slice(-120),96);
        const spread=(ema24-ema96)/ema96;
        const macd=EMA(closes.slice(-120),24)-EMA(closes.slice(-120),96);
        const volRatio=vols.at(-1)/(vols.slice(-48).reduce((a,b)=>a+b)/48);

        const z=beta[0]+beta[1]*latestRSI+beta[2]*spread+beta[3]*macd+beta[4]*volRatio;
        const prob=sigmoid(z);

        results.push({symbol:item.symbol,prob});

      }catch(e){}
    }));

    log("進度:"+Math.min(i+BATCH,top50.length)+"/50");
    await sleep(SLEEP);
  }

  results.sort((a,b)=>b.prob-a.prob);
  const top5=results.slice(0,5);

  document.getElementById("top5").innerHTML=
    top5.map(x=>`<li>${x.symbol} | 爆拉機率: ${(x.prob*100).toFixed(2)}%</li>`).join("");

  log("完成");
}

</script>
</body>
</html>
